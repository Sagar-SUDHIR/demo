<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Leave Requests - Vidyashree</title>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Rubik', sans-serif;
      background: linear-gradient(to right, #1a001f, #2c003e);
      color: white;
      min-height: 100vh;
      padding: 2rem;
    }
    h1 {
      color: gold;
      text-align: center;
      margin-bottom: 1rem;
    }
    #searchInput {
      display: block;
      margin: 0 auto 1.5rem auto;
      padding: 0.5rem 1rem;
      width: 300px;
      border-radius: 8px;
      border: none;
      font-size: 1rem;
      font-family: 'Rubik', sans-serif;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #3a0055;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
    }
    thead {
      background: #5a007a;
    }
    th, td {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #4e004b;
      text-align: left;
      vertical-align: middle;
    }
    th {
      color: gold;
      font-weight: 600;
    }
    tr:hover {
      background: rgba(255, 215, 0, 0.1);
    }
    .action-btn {
      background: gold;
      color: black;
      font-weight: 700;
      border: none;
      padding: 0.4rem 0.8rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      margin-right: 0.5rem;
      transition: background 0.3s ease;
    }
    .action-btn:hover:not(:disabled) {
      background: orange;
    }
    .action-btn:disabled {
      background: #bbb;
      cursor: default;
      color: #666;
    }
    .status {
      font-weight: 600;
      text-transform: capitalize;
    }
    .status.pending { color: gold; }
    .status.approved { color: #00c853; }
    .status.rejected { color: #d50000; }
    .no-data {
      text-align: center;
      margin-top: 3rem;
      font-size: 1.2rem;
      color: gold;
    }
  </style>
</head>
<body>
  <h1>Leave Requests - Admin Panel</h1>
  <input type="text" id="searchInput" placeholder="Search by Admission No. or Email..." />

  <div id="tableContainer">
    <p class="no-data">Loading leave requests...</p>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAcU6re1dMKhp-UEsr8uS-h26cvQ_Qo95I",
      authDomain: "vidyashree-d52ba.firebaseapp.com",
      projectId: "vidyashree-d52ba",
      storageBucket: "vidyashree-d52ba.appspot.com",
      messagingSenderId: "931104308675",
      appId: "1:931104308675:web:7335834a9a212714d41176",
      measurementId: "G-T4CKZX2E73"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const tableContainer = document.getElementById('tableContainer');
    const searchInput = document.getElementById('searchInput');

    let leaveRequests = []; // to keep all requests for filtering

    // Render table rows based on filtered data
    function renderTable(data) {
      if (data.length === 0) {
        tableContainer.innerHTML = '<p class="no-data">No leave requests found.</p>';
        return;
      }

      let tableHTML = `
        <table>
          <thead>
            <tr>
              <th>Admission No.</th>
              <th>Email</th>
              <th>Leave Start</th>
              <th>Leave End</th>
              <th>Reason</th>
              <th>Status</th>
              <th>Submitted At</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
      `;

      data.forEach(({ id, data }) => {
        const d = data;
        const startDate = d.startDate || '-';
        const endDate = d.endDate || '-';
        const reason = d.reason || '-';
        const email = d.email || '-';
        const admissionNumber = d.admissionNumber || '-';
        const timestamp = d.timestamp ? d.timestamp.toDate().toLocaleString() : '-';
        const status = d.status || 'pending';

        tableHTML += `
          <tr>
            <td>${admissionNumber}</td>
            <td>${email}</td>
            <td>${startDate}</td>
            <td>${endDate}</td>
            <td>${reason}</td>
            <td class="status ${status}">${status}</td>
            <td>${timestamp}</td>
            <td>
              <button class="action-btn approve-btn" data-id="${id}" ${status !== 'pending' ? 'disabled' : ''}>Approve</button>
              <button class="action-btn reject-btn" data-id="${id}" ${status !== 'pending' ? 'disabled' : ''}>Reject</button>
            </td>
          </tr>
        `;
      });

      tableHTML += '</tbody></table>';
      tableContainer.innerHTML = tableHTML;

      // Add event listeners to buttons
      document.querySelectorAll('.approve-btn').forEach(btn => {
        btn.addEventListener('click', () => updateStatus(btn.dataset.id, 'approved', btn));
      });
      document.querySelectorAll('.reject-btn').forEach(btn => {
        btn.addEventListener('click', () => updateStatus(btn.dataset.id, 'rejected', btn));
      });
    }

    async function updateStatus(docId, newStatus, button) {
      try {
        button.disabled = true;
        // Also disable the sibling button
        const siblingBtn = button.parentElement.querySelector(newStatus === 'approved' ? '.reject-btn' : '.approve-btn');
        if(siblingBtn) siblingBtn.disabled = true;

        await db.collection('leaveRequests').doc(docId).update({
          status: newStatus
        });
        alert(`Leave request ${newStatus}!`);
        // Update local data and re-render
        leaveRequests = leaveRequests.map(item => {
          if (item.id === docId) {
            item.data.status = newStatus;
          }
          return item;
        });
        renderTable(filterData(searchInput.value));
      } catch (error) {
        console.error('Error updating status:', error);
        alert('Failed to update status. Try again.');
        button.disabled = false;
        const siblingBtn = button.parentElement.querySelector('.approve-btn, .reject-btn');
        if(siblingBtn) siblingBtn.disabled = false;
      }
    }

    function filterData(searchTerm) {
      if (!searchTerm) return leaveRequests;
      searchTerm = searchTerm.toLowerCase();
      return leaveRequests.filter(({ data }) => {
        return (data.admissionNumber && data.admissionNumber.toLowerCase().includes(searchTerm)) ||
               (data.email && data.email.toLowerCase().includes(searchTerm));
      });
    }

    async function loadLeaveRequests() {
      tableContainer.innerHTML = '<p class="no-data">Loading leave requests...</p>';
      try {
        const snapshot = await db.collection('leaveRequests')
          .orderBy('timestamp', 'desc')
          .get();

        if (snapshot.empty) {
          leaveRequests = [];
          tableContainer.innerHTML = '<p class="no-data">No leave requests found.</p>';
          return;
        }

        leaveRequests = snapshot.docs.map(doc => ({
          id: doc.id,
          data: doc.data()
        }));

        renderTable(leaveRequests);
      } catch (error) {
        console.error('Error loading leave requests:', error);
        tableContainer.innerHTML = '<p class="no-data" style="color: red;">Failed to load leave requests. Please try again later.</p>';
      }
    }

    searchInput.addEventListener('input', () => {
      const filtered = filterData(searchInput.value);
      renderTable(filtered);
    });

    // Initial load
    loadLeaveRequests();
  </script>
</body>
</html>